<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Vòng Quay May Mắn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
    integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/spin-wheel@4.3.2/dist/spin-wheel-iife.js"></script>
  <link rel="icon" href="data:image/x-icon;," type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
  <!-- FONT -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
    rel="stylesheet">
  <!-- CSS -->
  <link rel="stylesheet" href="./style.css" />
</head>

<body style="font-family: Montserrat;">
  <div class="container row mx-auto">
    <div class="container__wheel col-md-9 col-sm-12">
      <div class="text-center">
        <img src="./title-spin-wheel.png" class="mt-5 mb-2" alt="" style="width: 300px">
      </div>
      <div class="wheel-wrapper"></div>
    </div>

    <div class="container__form col-md-3 col-sm-12 p-2 d-flex align-items-center">
      <form class="w-100">
        <div class="text-success text-center p-2" id="winning-item"></div>
        <div class="mb-3">
          <label for="name" class="form-label" style="font-size: 16px; font-weight: 500;">Họ Và Tên</label>
          <input type="text" class="form-control rounded-4" style="height: 45px" id="name" aria-describedby="emailHelp">
          <p style="display: none; font-size: 14px; padding-top: 5px;" id="nameError" class="text-danger">Họ tên trống
          </p>
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label" style="font-size: 16px; font-weight: 500;">Số Điện Thoại</label>
          <input type="text" class="form-control rounded-4" style="height: 45px" id="phone">
          <p style="display: none; font-size: 14px; padding-top: 5px;" id="phoneError" class="text-danger">Số điện thoại
            trống</p>
        </div>
        <button type="button" class="button-19" onclick="validateAndPlay()">Chơi Ngay</button>
      </form>
    </div>
  </div>
</body>

</html>
<script>
  let currentUserId = generateUniqueId();
  console.log('current User Id', currentUserId)

  let items = [
    {
      label: 'Japanese',
      lottery: 10,
    },
    {
      label: 'Fish N Chips',
      lottery: 30,
    },
    {
      label: 'Sandwich',
      lottery: 50,
    },
    {
      label: 'Sub Sandwich',
      lottery: 100,
    },
    {
      label: 'Tacos / Mexican',
      lottery: 100,
    },
    {
      label: 'Noodle Box',
      lottery: 100,
    },
  ];

  let spinItems = [];

  const props = {
    name: 'Vong Quay May Man',
    radius: 0.96,
    itemLabelFontSizeMax: 20,
    pointerAngle: 90,
    itemLabelRadius: 0.85,
    isInteractive: false,
    itemLabelRadiusMax: 0.17,
    itemLabelRotation: 0,
    itemLabelAlign: 'right',
    itemLabelColors: ['#fff'],
    itemLabelBaselineOffset: -0.06,
    itemLabelFont: 'Montserat',
    itemBackgroundColors: ['#BFC9CA', '#F1C40F', '#DE3163', '#1F618D', '#F8C471', '#2ECC71'],
    rotationSpeedMax: 700,
    rotationResistance: -110,
    lineWidth: 1,
    lineColor: '#F1C40F',
    borderWidth: 0,
    overlayImage: './arrow-overlay3.svg',
  };

  //https://stackoverflow.com/questions/33713084/download-link-for-google-spreadsheets-csv-export-with-multiple-sheets
  window.onload = async () => {
    await Papa.parse("https://docs.google.com/spreadsheets/d/1CNMhBvtRxnYN7F6Eu81CqtvET35uPOAoSVihpQi8kBQ/gviz/tq?tqx=out:csv&sheet=SpinItems", {
      download: true,
      header: true,
      downloadRequestHeaders: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
      },
      complete: function (results, file) {
        const items = results.data.map((item) => {
          if (item.lottery === undefined || item.lottery === null || item.lottery == '') {
            item.lottery = 1;
          }
          spinItems.push({
            label: item.label,
            lottery: parseInt(item.lottery, 10)
          })
        });

        init();
      }
    });
  };

  function validateAndPlay() {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();

    const nameError = document.getElementById('nameError');
    const phoneError = document.getElementById('phoneError');

    let isValid = true;

    if (name === '') {
      nameError.style.display = 'block';
      isValid = false;
    } else {
      nameError.style.display = 'none';
    }

    if (phone === '') {
      phoneError.style.display = 'block';
      isValid = false;
    } else {
      phoneError.style.display = 'none';
    }

    if (isValid) {
      window.wheel.spinToItem(getRandomItem(), 3000, false, 1, 1, null);
    }
  }

  async function init() {
    const wheel = new spinWheel.Wheel(document.querySelector('.wheel-wrapper'));

    wheel.init({
      ...props,
      items: spinItems.length > 0 ? spinItems : items,
      rotation: wheel.rotation,
      onRest: (event) => {
        const selectedItem = wheel.items[event.currentIndex].label;
        $('#winning-item').html('Chúc mừng bạn nhận được phần quà' + ' ' + `"${selectedItem}"`);

        const dataSend = {
          id: currentUserId,
          time: generateTimesapp(),
          name: document.getElementById('name').value,
          phone: document.getElementById('phone').value,
          product: selectedItem,
        }
        fetch("https://script.google.com/macros/s/AKfycbykIl0JqysLpglJX0SZmja8PYTdzqa3PS0iKk4E3jGPXYfwAPkfsTIS5sOfptvv4tIm3Q/exec",
          {
            method: 'POST',
            body: JSON.stringify(dataSend)
          }
        ).then((response) => {
          return response;
        }).then((jsonData) => {
          console.log('data', jsonData)
        })
          .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
          });

      },
    });

    window.wheel = wheel;

  }



  //hàm xét tỷ lệ cho vòng quay
  function getRandomItem() {

    const candidates = spinItems.length > 0 ? spinItems : items;
    // Tính tổng trọng số
    const totalWeight = candidates.reduce((sum, item) => sum + item.lottery, 0);
    // Tạo một số ngẫu nhiên từ 0 đến tổng trọng số
    let randomNum = Math.random() * totalWeight;
    // Duyệt qua các items và trừ trọng số cho đến khi randomNum <= 0
    for (let i = 0; i < candidates.length; i++) {
      randomNum -= candidates[i].lottery;
      if (randomNum <= 0) {
        return i;
      }
    }
  }

  //generate timesapp
  function generateTimesapp() {
    var date = new Date();
    const timesApp = date.toLocaleString('en-GB', { hour12: false });
    return timesApp;
  }

  //generate id
  function generateUniqueId() {
    var now = new Date();
    var id = 'ID-' + now.getFullYear() +
      ('0' + (now.getMonth() + 1)).slice(-2) +
      ('0' + now.getDate()).slice(-2) +
      ('0' + now.getHours()).slice(-2) +
      ('0' + now.getMinutes()).slice(-2) +

      ('0' + now.getSeconds()).slice(-2) +
      '-' + Math.floor(Math.random() * 1000);
    return id;
  }
</script>

<!-- //https://stackoverflow.com/questions/7431268/how-to-read-data-from-csv-file-using-javascript
    //https://www.jsdelivr.com/package/npm/papaparse?tab=stats
    https://stackoverflow.com/questions/33713084/download-link-for-google-spreadsheets-csv-export-with-multiple-sheets -->