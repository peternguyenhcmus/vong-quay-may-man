<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Vòng Quay May Mắn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
    integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/spin-wheel@4.3.2/dist/spin-wheel-iife.js"></script>
  <link rel="icon" href="data:image/x-icon;," type="image/x-icon">

</head>

<body>
  <div class="wheel-wrapper"></div>
  <div id="winning-item"></div>

  <form id="myForm">
    <label for="name">Name:</label>
    <input type="text" id="name" name="name" required>
    <br><br>
    <label for="phone">Phone:</label>
    <input type="tel" id="phone" name="phone" required>
    <br><br>
  </form>

  <button onclick="validateAndPlay()">PLAY</button>

</body>

</html>

<script>
  let id = generateUniqueId();

  let items = [
    {
      label: 'Japanese',
      lottery: 10,
    },
    {
      label: 'Fish N Chips',
      lottery: 30,
    },
    {
      label: 'Sandwich',
      lottery: 50,
    },
    {
      label: 'Sub Sandwich',
      lottery: 100,
    },
    {
      label: 'Tacos / Mexican',
      lottery: 100,
    },
    {
      label: 'Noodle Box',
      lottery: 100,
    },
  ];

  let spinItems = [];

  const props = {
    name: 'Takeaway',
    radius: 0.89,
    pointerAngle: 90,
    itemLabelRadius: 0.92,
    isInteractive: false,
    itemLabelRadiusMax: 0.37,
    itemLabelRotation: 0,
    itemLabelAlign: 'right',
    itemLabelColors: ['#000'],
    itemLabelBaselineOffset: -0.06,
    itemLabelFont: 'Rubik',
    itemBackgroundColors: ['#fbf8c4', '#e4f1aa', '#c0d26e', '#ff7d7d'],
    rotationSpeedMax: 700,
    rotationResistance: -110,
    lineWidth: 0,
    overlayImage: './arrow-overlay.svg',
    borderWidth: 0,
  };

  //https://stackoverflow.com/questions/33713084/download-link-for-google-spreadsheets-csv-export-with-multiple-sheets
  window.onload = async () => {
    await Papa.parse("https://docs.google.com/spreadsheets/d/1CNMhBvtRxnYN7F6Eu81CqtvET35uPOAoSVihpQi8kBQ/gviz/tq?tqx=out:csv&sheet=SpinItems", {
      download: true,
      header: true,
      downloadRequestHeaders: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
      },
      complete: function (results, file) {
        const items = results.data.map((item) => {
          if (item.lottery === undefined || item.lottery === null || item.lottery == '') {
            item.lottery = 1;
          }
          spinItems.push({
            label: item.label,
            lottery: parseInt(item.lottery, 10)
          })
        });

        init();
      }
    });
  };

  function validateAndPlay() {
    const input_name = document.getElementById('name').value;
    const input_phone = document.getElementById('phone').value;

    if (!input_name) {
      alert('Vui lòng nhập tên khách hàng');
      return;
    }

    if (!input_phone) {
      alert('Vui lòng nhập số điện thoại khách hàng');
      return;
    }
    window.wheel.spinToItem(getRandomItem(), 3000, false, 1, 1, null);
  }

  async function init() {
    const wheel = new spinWheel.Wheel(document.querySelector('.wheel-wrapper'));

    wheel.init({
      ...props,
      items: spinItems.length > 0 ? spinItems : items,
      rotation: wheel.rotation,
      onRest: (event) => {
        const selectedItem = wheel.items[event.currentIndex].label;
        $('#winning-item').html(selectedItem);

        const dataSend = {
          id: id,
          time: generateTimesapp(),
          name: document.getElementById('name').value,
          phone: document.getElementById('phone').value,
          product: selectedItem,
        }
        fetch("https://script.google.com/macros/s/AKfycbykIl0JqysLpglJX0SZmja8PYTdzqa3PS0iKk4E3jGPXYfwAPkfsTIS5sOfptvv4tIm3Q/exec",
          {
            method: 'POST',
            body: JSON.stringify(dataSend)
          }
        ).then((response) => {
          return response;
        }).then((jsonData) => {
          console.log('data', jsonData)
        })
          .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
          });

      },
    });

    window.wheel = wheel;

  }



  //hàm xét tỷ lệ cho vòng quay
  function getRandomItem() {

    const candidates = spinItems.length > 0 ? spinItems : items;
    // Tính tổng trọng số
    const totalWeight = candidates.reduce((sum, item) => sum + item.lottery, 0);
    // Tạo một số ngẫu nhiên từ 0 đến tổng trọng số
    let randomNum = Math.random() * totalWeight;
    // Duyệt qua các items và trừ trọng số cho đến khi randomNum <= 0
    for (let i = 0; i < candidates.length; i++) {
      randomNum -= candidates[i].lottery;
      if (randomNum <= 0) {
        return i;
      }
    }
  }

  //generate timesapp
  function generateTimesapp() {
    var date = new Date();
    const timesApp = date.toLocaleString('en-GB', { hour12: false });
    return timesApp;
  }

  //generate id
  function generateUniqueId() {
    var now = new Date();
    var id = 'ID-' + now.getFullYear() +
      ('0' + (now.getMonth() + 1)).slice(-2) +
      ('0' + now.getDate()).slice(-2) +
      ('0' + now.getHours()).slice(-2) +
      ('0' + now.getMinutes()).slice(-2) +
      
      ('0' + now.getSeconds()).slice(-2) +
      '-' + Math.floor(Math.random() * 1000);
    return id;
  }
</script>

<!-- //https://stackoverflow.com/questions/7431268/how-to-read-data-from-csv-file-using-javascript
    //https://www.jsdelivr.com/package/npm/papaparse?tab=stats
    https://stackoverflow.com/questions/33713084/download-link-for-google-spreadsheets-csv-export-with-multiple-sheets -->